<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>アモニ大戦争</title>
<style>
body{
margin:0;
background:black;
overflow:hidden;
color:white;
font-family:sans-serif;
touch-action:none;
}
canvas{
display:block;
margin:auto;
background:black;
}
</style>
</head>
<body>

<canvas id="game" width="360" height="640"></canvas>

<script>
const canvas=document.getElementById("game");
const ctx=canvas.getContext("2d");

let state="title";
let difficulty="normal";
let characterType="power";

let player;
let bullets=[];
let enemies=[];
let enemyBullets=[];
let score=0;
let specialGauge=0;
let stage=1;
let flash=0;

let touchActive=false;
let touchOffsetX=0;
let touchOffsetY=0;

// 画像
const imgPower=new Image(); imgPower.src="power.png";
const imgSpeed=new Image(); imgSpeed.src="speed.png";
const imgDefense=new Image(); imgDefense.src="defense.png";
const imgEnemy1=new Image(); imgEnemy1.src="enemy1.png";
const imgEnemy2=new Image(); imgEnemy2.src="enemy2.png";
const imgEnemy3=new Image(); imgEnemy3.src="enemy3.png";
const imgBoss=new Image(); imgBoss.src="boss.png";

function createPlayer(){
let hp=100,speed=4,power=1;
if(characterType==="power"){hp=100;power=2;}
if(characterType==="speed"){hp=80;}
if(characterType==="defense"){hp=150;}

player={
x:160,y:550,w:40,h:40,
hp:hp,maxHp:hp,
power:power,
img: characterType==="power"?imgPower:
     characterType==="speed"?imgSpeed:imgDefense
};
}

function spawnEnemy(){
let rate=0.02;
if(difficulty==="easy") rate=0.01;
if(difficulty==="hard") rate=0.04;

if(Math.random()<rate){
let type=Math.floor(Math.random()*3)+1;
enemies.push({
x:Math.random()*320,
y:-40,
w:40,h:40,
type:type,
hp:type===1?20:type===2?40:60,
moveX:type===2?2:0,
img:type===1?imgEnemy1:type===2?imgEnemy2:imgEnemy3
});
}
}

function update(){
if(state!=="play") return;

spawnEnemy();

if(score>stage*1000){
stage++;
enemies.push({
x:80,y:-100,
w:200,h:120,
type:"boss",
hp:800,
img:imgBoss
});
}

if(touchActive){
if(Math.random()<0.25){
bullets.push({x:player.x+20,y:player.y});
}
}

enemies.forEach((e,i)=>{

if(e.type==="boss"){
if(e.y<50) e.y+=1;
if(Math.random()<0.03){
enemyBullets.push({x:e.x+100,y:e.y+100,dx:0});
}
}
else{
e.y+=2;

if(e.type===2){
e.x+=e.moveX;
if(e.x<0||e.x>320) e.moveX*=-1;
}

if(e.type===3 && Math.random()<0.02){
enemyBullets.push({x:e.x+20,y:e.y+40,dx:-2});
enemyBullets.push({x:e.x+20,y:e.y+40,dx:2});
}

if(Math.random()<0.01){
enemyBullets.push({x:e.x+20,y:e.y+40,dx:0});
}
}

if(hit(e,player)){
player.hp-=20;
enemies.splice(i,1);
}
});

enemyBullets.forEach((b,i)=>{
b.y+=4;
b.x+=b.dx||0;

if(hit(b,player)){
player.hp-=10;
enemyBullets.splice(i,1);
}

if(b.y>640) enemyBullets.splice(i,1);
});

bullets.forEach((b,i)=>{
b.y-=8;

enemies.forEach((e,ei)=>{
if(hit(b,e)){
e.hp-=10*player.power;
bullets.splice(i,1);

if(e.hp<=0){
score+= e.type==="boss"?1000:100;
specialGauge+=10;
if(specialGauge>100) specialGauge=100;
enemies.splice(ei,1);
}
}
});

if(b.y<0) bullets.splice(i,1);
});

if(player.hp<=0) state="gameover";
if(flash>0) flash--;
}

function draw(){
ctx.clearRect(0,0,360,640);

ctx.fillStyle="white";

if(state==="title"){
ctx.font="30px sans-serif";
ctx.fillText("アモニ大戦争",70,200);
ctx.font="20px sans-serif";
ctx.fillText("TAP TO START",100,350);
}

if(state==="difficulty"){
ctx.fillText("難易度選択",110,200);
ctx.fillText("EASY",140,300);
ctx.fillText("NORMAL",130,350);
ctx.fillText("HARD",140,400);
}

if(state==="character"){
ctx.fillText("キャラ選択",120,200);
ctx.fillText("パワー型",130,300);
ctx.fillText("スピード型",120,350);
ctx.fillText("ディフェンス型",110,400);
}

if(state==="play"){
ctx.drawImage(player.img,player.x,player.y,player.w,player.h);
enemies.forEach(e=>ctx.drawImage(e.img,e.x,e.y,e.w,e.h));

ctx.fillStyle="blue";
bullets.forEach(b=>ctx.fillRect(b.x,b.y,5,10));

ctx.fillStyle="red";
enemyBullets.forEach(b=>ctx.fillRect(b.x,b.y,5,10));

ctx.fillStyle="green";
ctx.fillRect(10,10,(player.hp/player.maxHp)*100,10);

ctx.fillStyle="blue";
ctx.fillRect(10,30,specialGauge,10);

ctx.fillStyle="white";
ctx.fillText("Score:"+score,200,20);
}

if(state==="gameover"){
ctx.fillStyle="red";
ctx.fillText("GAME OVER",80,300);
ctx.fillStyle="white";
ctx.fillText("Score:"+score,110,350);
}
}

function hit(a,b){
return a.x<b.x+b.w &&
       a.x+5>b.x &&
       a.y<b.y+b.h &&
       a.y+10>b.y;
}

/* ===== スワイプ操作 ===== */

canvas.addEventListener("touchstart",e=>{
const rect=canvas.getBoundingClientRect();
const x=e.touches[0].clientX-rect.left;
const y=e.touches[0].clientY-rect.top;

if(state==="title"){state="difficulty";return;}
if(state==="difficulty"){
if(y>280&&y<320)difficulty="easy";
if(y>330&&y<370)difficulty="normal";
if(y>380&&y<420)difficulty="hard";
state="character";return;
}
if(state==="character"){
if(y>280&&y<320)characterType="power";
if(y>330&&y<370)characterType="speed";
if(y>380&&y<420)characterType="defense";
start();return;
}
if(state==="play"){
if(y>580 && specialGauge>=100){
score+=enemies.length*100;
enemies=[];
specialGauge=0;
flash=10;
return;
}
touchActive=true;
touchOffsetX=x-player.x;
touchOffsetY=y-player.y;
}
});

canvas.addEventListener("touchmove",e=>{
if(!touchActive) return;
const rect=canvas.getBoundingClientRect();
player.x=e.touches[0].clientX-rect.left-touchOffsetX;
player.y=e.touches[0].clientY-rect.top-touchOffsetY;

if(player.x<0)player.x=0;
if(player.x>320)player.x=320;
if(player.y<0)player.y=0;
if(player.y>600)player.y=600;
});

canvas.addEventListener("touchend",()=>{
touchActive=false;
});

function start(){
state="play";
score=0;
specialGauge=0;
bullets=[];
enemies=[];
enemyBullets=[];
stage=1;
createPlayer();
}

function loop(){update();draw();requestAnimationFrame(loop);}
loop();
</script>
</body>
</html>
